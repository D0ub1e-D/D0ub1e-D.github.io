



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="中二笔记 · 癫^.^" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="中二笔记 · 癫^.^" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="中二笔记 · 癫^.^" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="初探Fuzzing,二进制,模糊测试" />


<link rel="canonical" href="http://example.com/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/">



  <title>
AFL基础学习 - Fuzzing模糊测试 |
D0ub1e_D = 中二笔记 · 癫^.^ = 或许我会找到她/他/它......</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">AFL基础学习
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2022-07-02 15:30:16">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2022-07-02T15:30:16+08:00">2022-07-02</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">D0ub1e_D</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/0067J33Vly8h4f34pppujj31hc0u0q7h.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/0067J33Vly8h4f3a4ipnaj31hc0u07e8.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/0067J33Vly8h4f3547xrvj31hc0u0dmp.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/0067J33Vly8h4f34z1txcj31hc0u07a5.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/0067J33Vly8h4f34u63a7j31hc0u043z.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/0067J33Vly8h4f2ydc92rj31hc0u0490.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Fuzzing%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/" itemprop="item" rel="index" title="分类于 Fuzzing模糊测试"><span itemprop="name">Fuzzing模糊测试</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="Siegfried">
    <meta itemprop="description" content="或许我会找到她/他/它......, 希望沉醉在二进制的乌托邦里！">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="中二笔记 · 癫^.^">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="afl基础学习"><a class="markdownIt-Anchor" href="#afl基础学习">#</a> AFL 基础学习</h1>
<h4 id="前言afl适用于linux环境下的cc程序进行自动化的fuzzing测试工具"><a class="markdownIt-Anchor" href="#前言afl适用于linux环境下的cc程序进行自动化的fuzzing测试工具">#</a> 前言：AFL 适用于 Linux 环境下的 C/C++ 程序进行自动化的 Fuzzing 测试工具。</h4>
<h3 id="一-fuzzing对象"><a class="markdownIt-Anchor" href="#一-fuzzing对象">#</a> 一、Fuzzing 对象</h3>
<p>（1）针对已知源码的程序，AFL 提供 afl-gcc/g++/clang 对其进行插桩编译，通过使用种子（testcase 我的理解是语料库）进行变异、遗传算法等策略，再对软件的输入输出流进行测试，从而使程序 crash，接着再从 crash 中查看具体的执行语句、执行位置，接着收集信息用于触发漏洞的 testcase 制作，再使用 gdb 对程序进行调试，发现并触发 testcase 测试漏洞。（根据很多比较新的 fuzz 文章都提倡使用 clang 或 clang<ins> 来进行编译插桩，也许是在编译角度上无论是速度还是优化都更优于 gcc/g</ins>。）</p>
<p>（2）针对无源码的程序，有两种解决办法：1、利用 QEMU 模拟器对其二进制文件进行插桩。2、使用传统的 - n 参数直接进行测试。对于第二种方法网上可以找到的资料很少，感觉并不适用，因为既然可以使用 QEMU 进行插桩，显然可以提高 fuzz 的成功率，所以在这里就没有过分深究这种方法。</p>
<h3 id="二-关于代码插桩"><a class="markdownIt-Anchor" href="#二-关于代码插桩">#</a> 二、关于代码插桩</h3>
<h4 id="1-代码插桩到fuzzing的流程"><a class="markdownIt-Anchor" href="#1-代码插桩到fuzzing的流程">#</a> 1、代码插桩到 fuzzing 的流程：</h4>
<p>     a. 调用 linux 下汇编器 as 插入桩代码 → b. forksever 进行 fork 与 fuzzer 通信 → c. AFL 使用共享内存进行 fuzzer 与 target 程序之间的信息传递 → d. 不同的 fork 信息进行记录。</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_qj43vg48XH-16584305597151.png" class="">
<h4 id="2-调用linux下汇编器as插入桩代码"><a class="markdownIt-Anchor" href="#2-调用linux下汇编器as插入桩代码">#</a> 2、调用 linux 下汇编器 as 插入桩代码：</h4>
<p>     我们知道源码编译过程是：高级语言代码→汇编代码→二进制代码，根据该文章和资料提供的样例，发现的确在编译过程，生成了一个 as 文件夹，再根据 linux 下的汇编器是 as，可以明确插入桩代码的关键点在于 &quot;汇编代码&quot; 的阶段，并且在 AFL 的目录下也找到了 afl-as.c 文件，对其源代码和资料进行分析可知：在分支处插入的代码为：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">fprintf</span><span class="token punctuation">(</span>outf<span class="token punctuation">,</span> use_64bit <span class="token operator">?</span> trampoline_fmt_64 <span class="token operator">:</span> trampoline_fmt_32<span class="token punctuation">,</span> <span class="token function">R</span><span class="token punctuation">(</span>MAP_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这里的参数 R (MAP_SIZE) 是关键，接下来，按照文章的逻辑分析 trampoline_fmt_32 为例的情况：</p>
<p>trampoline_fmt_32 内容大致可以概括为：（1）将分支处 ecx 寄存器值设置为 fprintf 中的内容。</p>
<p>                                                                 （2）调用 call 函数执行__afl_maybe_log () 方法。</p>
<p>再解读 fprintf 中的内容：（根据文章的解读进行概括）ecx 中的值就是 R (MAP_SIZE)，接着作者分析了宏 MAP_SIZE 的定义，可知其大小为 64K，再给出 R (X) 的定义为：(random () % (x))。因此这样就很容易理解，ecx 寄存器中的值被设置为了 0 到 MAP_SIZE 中的一个随机数。</p>
<blockquote>
<p><strong>总结：由以上分析可知，每当编译到一个分支都会插入这段代码，同时修改 ecx 寄存器的值为 afl-as 生成的随机数，这个随机数是用来识别该段分支代块的 key。</strong></p>
</blockquote>
<h4 id="3-forksever进行fork与fuzzer通信"><a class="markdownIt-Anchor" href="#3-forksever进行fork与fuzzer通信">#</a> 3、 forksever 进行 fork 与 fuzzer 通信：</h4>
<p>     引用文章原文：“启动 target 进程后，target 会运行一个 fork server；fuzzer 并不负责 fork 子进程，而是与这个 fork server 通信，并由 fork server 来完成 fork 及继续执行目标的操作。这样设计的最大好处，就是不需要调用 <code>execve()</code> ，从而节省了载入目标文件和库、解析符号地址等重复性工作”</p>
<p>（由于现阶段并不是很清楚是否需要深究这套机制原理，所以在概念上引用了文章原话）</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_o03NNnDmmm.png" class="">
<blockquote>
<p><strong>总结：为了高效完成 fuzzing，AFL 使用 forksever 的机制。并在该机制中使用了__afl_maybe_log () 方法，及该方法中的其他方法。其目的主要是如上文所述，其次还有传递给 fuzzer 不同 fork 的执行情况并记录。</strong></p>
</blockquote>
<h4 id="4-afl使用共享内存进行fuzzer与target程序之间的信息传递"><a class="markdownIt-Anchor" href="#4-afl使用共享内存进行fuzzer与target程序之间的信息传递">#</a> 4、AFL 使用共享内存进行 fuzzer 与 target 程序之间的信息传递：</h4>
<p>     AFL 使用共享内存的主要目的用于 fuzzer 与 target 程序之间的信息传递，在 fuzzer 启动的时候会分配一块共享内存，该共享内存大小为 MAP_SIZE 为 64K，当使用 forksever 模式进行，该共享内存就是在该模式下进行的。此外，当 fork 的子进程直接会使用这个共享内存。（暂时不做深究，目的在于现阶段了解机制）</p>
<h4 id="5-不同的fork信息进行记录分析"><a class="markdownIt-Anchor" href="#5-不同的fork信息进行记录分析">#</a> 5、不同的 fork 信息进行记录 &amp; 分析：</h4>
<p>     完成了上述三个流程，接下来就要搞清通信的内容。看了文章再结合文章中所给的 AFL 源码中的伪代码，可以总结为：“AFL 是根据二元 tuple (跳转的源地址和目标地址) 来记录分支信息，从而获取 target 的执行流程和代码覆盖情况。” 而这里的记录的分支信息是什么呢？AFL 插桩的时候在每个分支会生成一个随机数用来记录，并对分支处的 &quot;原位置&quot; 与 &quot;目标位置&quot; 进行异或，异或的结果标记为该分支段的 key（其保存每个分支执行的次数）。因此，每当执行分支都会改变其 key 值。用于保存 key 值的实际上是一个哈希表，大小为 MAP_SIZE 为 64K。</p>
<p>     fuzzer 除了 dumb 模式的无脑更为随机化的测试，都是有着测试路径的，因此每条路径的执行情况，都是通过计算其 hash 值来进行判断的。</p>
<h4 id="总结我现阶段对编译插桩的浅显理解为其主要目的在于记录并分析代码分支段的执行情况-次数-崩溃情况等等"><a class="markdownIt-Anchor" href="#总结我现阶段对编译插桩的浅显理解为其主要目的在于记录并分析代码分支段的执行情况-次数-崩溃情况等等">#</a> 总结：我现阶段对编译插桩的浅显理解为，其主要目的在于记录并分析代码分支段的执行情况、次数、崩溃情况等等。</h4>
<blockquote>
<p>⚠️资料参照<span class="exturl" data-url="aHR0cHM6Ly9yazcwMC5naXRodWIuaW8vMjAxNy8xMi8yOC9hZmwtaW50ZXJuYWxzLw=="> https://rk700.github.io/2017/12/28/afl-internals/</span> 这篇分析</p>
</blockquote>
<h3 id="三-关于afl的种子变异策略"><a class="markdownIt-Anchor" href="#三-关于afl的种子变异策略">#</a> 三、关于 AFL 的种子变异策略</h3>
<p>（由于没有深入研究源码，因此仅对变异的策略进行大致的了解）</p>
<h4 id="1文件变异方法"><a class="markdownIt-Anchor" href="#1文件变异方法">#</a> （1）文件变异方法：</h4>
<p>      1、bitflip：位反转。将每一位 bit（一位、相邻两位…）进行 0 变 1，1 变 0 的操作。</p>
<p>      2、arithmetic：从每 8bit 级别（byte、word、dword）进行加减操作。</p>
<p>      3、interest：和 arithmetic 操作类似，但不是进行加减，而是对文件内容进行替换；</p>
<p>      4、dictionary： 用户提供的字典里有 token，用来替换要进行变异的文件内容，如果用户没提供就使用 bitflip 自动生成的 token。（这点不是很理解）</p>
<p>      5、havoc：“大破坏”。指对文件进行真正的随机化处理，进行绝大程度上的 &quot;变异&quot;，做到绝对的 &quot;破坏&quot;，使其成为一个 &quot;新&quot; 文件。</p>
<p>      6、splice：&quot;拼接&quot; 文件，通过一定规则，如：两文件差异不大，就舍弃重选；如果差异很大，就把文件半劈拼接成一个新的文件。</p>
<h4 id="2文件变异策略"><a class="markdownIt-Anchor" href="#2文件变异策略">#</a> （2）文件变异策略：</h4>
<p>     dumb mode 和主 fuzzer 才会进行 deterministic fuzzing 过程（bitflip、arithmetic、interest、dictionary）的操作。而 havoc、splice 是真正的随机化，是每一个 fuzzing 都会进行的变异操作过程。</p>
<blockquote>
<p>（这里存在争议，在不同的文章中发现结论并不一致，不排除无脑搬运的情况，根据对源码的分析，认为应该以<span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vd2F5bmUtdGFvL3AvMTIwMTk0OTkuaHRtbA=="> https://www.cnblogs.com/wayne-tao/p/12019499.html</span> 这篇文章为准，从逻辑上分析变异的随机性与不随机性更说得通）。</p>
</blockquote>
<p>     在第一次变异后生成的文件，会在 cycle 队列中循环往复的变异下去，并且不会再进行和第一次一样的 deterministic fuzzing 操作，之后的变异循环只有随机性的变异操作了。</p>
<h3 id="四-afl相关工具使用及参数解读"><a class="markdownIt-Anchor" href="#四-afl相关工具使用及参数解读">#</a> 四、AFL 相关工具使用及参数解读：</h3>
<h4 id="1-afl-fuzz常用参数"><a class="markdownIt-Anchor" href="#1-afl-fuzz常用参数">#</a> 1、afl-fuzz 常用参数：</h4>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_zuMEQbgrlk.png" class="">
<h4 id="2-afl常用工具"><a class="markdownIt-Anchor" href="#2-afl常用工具">#</a> 2、afl 常用工具：</h4>
<h4 id="1afl-cmin"><a class="markdownIt-Anchor" href="#1afl-cmin">#</a> （1）afl-cmin：</h4>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_4tXAUBuFPw.png" class="" title="通过查看官方文档，可以大致明确cmin的是用来shrink自己的corpus的，具体是如何shrink的，还是要看一下例子">
<p>a. 先创建一些随机输入的 case（随便输入些乱七八糟的字符串）用于构建一个有相对内容的 corpus</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_WL0y2lOwKt.png" class="">
<p>b. 查看 afl-cmin 的使用指南：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_wF4u8OsIFs.png" class="" title="可见命令很简单和fuzzer启动一样-i是语料库的文件夹(in)，-o是输出的最小case的内容(out)，其他一些参数和afl-fuzz没有什么区别。">
<p>c. 使用 afl-cmin -i fuzz_in -o fuzz_cmin_out ./test1 命令进行 cmin 修减 corpus</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_U_D1K9dJGf.png" class="" title="这里提到了一个WARNING，提示我写的8个case在测试文件中都得到了相同的traces，大致就是case写的很无语，都是字符串类型，没有什么有效变异可以利用，所以就把所有没用的、多余的字符串都删掉了。">
<p>d. 最后整合的结果居然只有这么点。。。其实也可以理解，毕竟我写的 case 只是单纯在这个基础上进行的无效输入。</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_mf16ox5mdf.png" class="">
<h4 id="总结cmin的处理方式以我的例子来看再结合资料可以知道cmin就是从case1开始测试如果case2case-the-end都会达到相同的效果那么在测试的过程中逐一舍去只保留case1"><a class="markdownIt-Anchor" href="#总结cmin的处理方式以我的例子来看再结合资料可以知道cmin就是从case1开始测试如果case2case-the-end都会达到相同的效果那么在测试的过程中逐一舍去只保留case1">#</a> 总结：cmin 的处理方式以我的例子来看再结合资料，可以知道 cmin 就是从 case1 开始测试，如果 case2…case the end 都会达到相同的效果，那么在测试的过程中逐一舍去，只保留 case1.</h4>
<h4 id="2afl-tmin"><a class="markdownIt-Anchor" href="#2afl-tmin">#</a> （2）afl-tmin：</h4>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_4D6rgXNmVD.png" class="">
<p>tmin 的目的看上去和 cmin 没什么太大差别，但是不同的是，tmin 仅对单个文件进行 minimization 操作，并输出单个文件，那么就要看一下它是如何进行的。</p>
<p>a. 也是先来看下 tmin 的指南：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_KFl3uwd-CE.png" class="" title="命令依旧很简单，但是 -i指定的是目标的testcase文件，-o的是out出单个文件">
<p>b. 使用命令 afl-tmin -i fuzz_in/test_6.testcase -o fuzz_tmin_out ./test1 测试：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_YmanhyrjKw.png" class="">
<p>c. 查看 tmin 后输出的 case 文件：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_TxKFVMK-Vo.png" class="" title="很迷惑为什么输出的都是0？">
<p>经过查阅资料了解到，如果 case 文件写的太垃圾，tmin 觉得没用，就会全部删掉，但是看到这个资料的师傅遇到了一个 [!] WARNING: Down to zero bytes - check the command line and mem limit! 的问题，我认为理应我也应该出现这个错误提示，但是在这里却没有提示，也是很迷惑。。。但是原理搞懂了就好，目前由于没有研究源码，所以此处也没法深究太多。</p>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vd2F5bmUtdGFvL3AvMTE4ODk3MTguaHRtbA==">https://www.cnblogs.com/wayne-tao/p/11889718.html</span></p>
</blockquote>
<p><strong>注：tmin -i 的单个文件不一定是文本文件，也可以是 binary 文件！</strong></p>
<h4 id="3afl-plot"><a class="markdownIt-Anchor" href="#3afl-plot">#</a> （3）afl-plot：</h4>
<p>根据 afl-plot 的说明可知，在一次模糊测试的过程中他会生成相关的图片和 html 用来统计一些信息。</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_PXwpxeGuPA.png" class="">
<p>a. 第一次执行 afl-plot fuzz_out out_image 的时候不成功，提示找不到 gnuplot，后来查了一下 gnuplot 是一个画图工具，因此需要安装一下 gnuplot</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_jiganiVmHj.png" class="">
<p>执行：sudo apt-get install gnuplot</p>
<p>b. 安装好之后，按照指令，从 fuzz 输出的文件夹，生成图表到一个空 dir 中：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_eieA_DR07H.png" class="">
<p>c. 直接进入网页端查看生成的 plot：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_xTGWvjjbl6.png" class="" title="plot生成图表的目录中的结构">
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_QlgqqWrXLA.png" class="" title="最近一次fuzz结果的可视化分析结果">
<h4 id="4afl-whatsup"><a class="markdownIt-Anchor" href="#4afl-whatsup">#</a> （4）afl-whatsup：</h4>
<p>当开多个窗口进行 fuzz 的时候就需要一个全局管理器，用于查看该管理器（容器）中的各个子窗口的执行情况，这个时候可以使用 whatsup 进行管理。</p>
<p>这里对指令进行了了解，但是由于我的配置原因没法进行并行测试，所以这个暂且搁置，目前似乎也不是很重要，只是辅助功能。</p>
<h3 id="五-完整fuzzing测试流程"><a class="markdownIt-Anchor" href="#五-完整fuzzing测试流程">#</a> 五、完整 Fuzzing 测试流程</h3>
<h4 id="1-对有源码程序进行普通fuzzing测试"><a class="markdownIt-Anchor" href="#1-对有源码程序进行普通fuzzing测试">#</a> 1、对有源码程序进行普通 fuzzing 测试：</h4>
<p>（1）安装 afl 并使用 afl-gcc 进行源码编译：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_to3pzsGNAW.png" class="" title="在编译过程提示了gets函数没做限制，不安全，建议更换为fgets">
<p>（2）执行 afl-fuzz -i dir -o dir ./exec 命令</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_18vp7kR67m.png" class="" title="通常第一次使用afl都会出现这个错误，需要使用echo core &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;core\_pattern这个命令解决">
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_NO1FXsKy1T.png" class="" title="解决成功roll起fuzz">
<p>（3）执行 fuzz 命令之后出现了个奇怪的问题：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_1kRU8XAuvj.png" class="" title="这个none yet（odd，check syntax！）的问题困扰了我很久，排除了1、内存大小限制 2、标准输入流stdin(-f)参数 3、使用@@加路径 这几个方法都不能解决这个问题，后来经过不断的尝试发现这个问题，提示命令行参数语法错误的原因在于，源代码中的stdin输入路径是有问题的，这个地方我目前的水平没法给出一个非常明确的解释，但可以肯定的是和源代码有关，如文件头、输入流stdin的定义等等。起初代码中将gets改为read(stdin, buf, 100)并不管用，后来换了一套别人用来测试的写好的代码，居然解决掉这个问题了。看来问题还是出现在源码上。。。">
<p>使用的源码如下：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">//gets(buf);</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token operator">*</span><span class="token operator">/</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span> </span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span> </span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span> </span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span> </span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span> </span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">int</span> <span class="token function">vuln</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'A'</span> <span class="token operator">&amp;&amp;</span> len <span class="token operator">==</span> <span class="token number">66</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">raise</span><span class="token punctuation">(</span>SIGSEGV<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 如果输入的字符串的首字符为 A 并且长度为 66，则异常退出</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'F'</span> <span class="token operator">&amp;&amp;</span> len <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">raise</span><span class="token punctuation">(</span>SIGSEGV<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 如果输入的字符串的首字符为 F 并且长度为 6，则异常退出</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"it is good!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token function">gets</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 存在栈溢出漏洞</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token function">printf</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 存在格式化字符串漏洞</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token function">vuln</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>（4）解决掉这个问题之后，发现 crash，但是此时需要确定什么时候应该结束 fuzzing</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_2bgsdVwyVO.png" class="">
<p>根据资料和对官方源码的部分分析，可知从 process timing 块中的 last uniq crash（最近一次 crash 的时间）分析，如果该时间很长时间都没有更新，说明无论文件如何变异，对其测试的路径都没有更新了，结合上面提到的 &quot;插桩编译、信息传递&quot; 的知识不难理解此时已经没有什么有价值的 crash 值得等待了，这个时候就该 crtl+c 结束 fuzzing 了。</p>
<p>（当然简单的 fuzzing 可以通过 cycles done 的颜色变化来决定什么时候结束 fuzzing）</p>
<p>（5）分析 crash 并验证（小迷惑）：</p>
<p>这里用到了一个叫地址消毒的工具，也是 google 开发的，叫做 ASAN（Address Sanitizer）是一种地址错误检查器。</p>
<p>先使用 xxd 对得到的 binary 文件进行 dump 查看一下内容：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_T0NJLVTnUi.png" class="" title="盲猜这个应该是属于栈溢出？">
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_VZKJsV8yJn.png" class="" title="这里关注id为000001的crash，可以看到触发了vuln中的首字母为F且长度为6的情况，得到了aborting">
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_-5qWqiNxuE.png" class="" title="这里感觉像是格式化字符串，但是对pwn这块内容还没有学到，留坑待补">
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_HJJn-SdNqF.png" class="" title="这个可以看到触发了vuln中的判断条件首字母为A且长度为66的情况弹出aborting">
<p>光得到 crash 文件仅仅是开始，我们还要看下触发异常的位置、代码行号、可能的问题类型：</p>
<p>这里就要使用之前提到的 ASAN 做定位：（这里仅对两个 crash 进行验证）</p>
<p>a. 首先使用 - fsanitize=address 参数重新编译源代码：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_DRgDvluVvU.png" class="" title="编译过程中的warning提示了可能会出现的问题，并且出现ASAN mode的提示">
<p>b. 运行编译出来的 a.out 文件，输入 crash 样本中的内容，得到 aborting 分析：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_k7URgNHYQX.png" class="">
<p>c. 另一个 crash 分析报告如下：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_gEdWeU7Usj.png" class="">
<h4 id="2-对有源码程序进行dumb-mode-d测试"><a class="markdownIt-Anchor" href="#2-对有源码程序进行dumb-mode-d测试">#</a> 2、对有源码程序进行 dumb mode (-d) 测试：</h4>
<p>貌似加了 - d 参数并没有什么特别的，可能只是因为单纯改变了变异策略，并不影响测试结果（对于开源小代码）</p>
<h4 id="3-对有源码程序进行并行测试fuzzer-m-s"><a class="markdownIt-Anchor" href="#3-对有源码程序进行并行测试fuzzer-m-s">#</a> 3、对有源码程序进行并行测试 fuzzer (-M -S)：</h4>
<p>我个人认为对于多线程的系统来讲，单纯对大项目进行单一的主线程 fuzzing 是浪费资源，为了充分提高资源利用率，AFL 提供了并行模式，-M (Master)、-S (Slave)，M 为主进程，S 为子进程（把 M 比作 father，S 就是 son）很容易理解，使用方法就是 - M/S 参数后加 name</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_p6XwtvVL5P.png" class="" title="这里就遇到了一个很无语的问题，由于我虚拟机配置问题，导致我无法并行操作进行测试。。。看到很多师傅配置很高还有的走实体机，但是据说会烧ssd，感觉还是很恐怖。但是很多师傅貌似都是在服务器上进行的测试实验。">
<h4 id="4-对无源码的程序进行qemu-mode测试"><a class="markdownIt-Anchor" href="#4-对无源码的程序进行qemu-mode测试">#</a> 4、对无源码的程序进行 QEMU mode 测试：</h4>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_6I4my1C8R-.png" class="" title="首先安装qemu所需要的组件">
<p>错误未解决：</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_qFk-1tWkmk.png" class="" title="按部就班的进行直到出现这个问题。。。非常无语，查阅了相关的资料，可以得出一个结论就是qemu可能并不支持python3，他兼容的是python2.7版本，我不太想进行环境更改，因为这个虚拟机还有很多任务要用到python3。">
<blockquote>
<p>按部就班的进行直到出现这个问题。。。非常无语，查阅了相关的资料，可以得出一个结论就是 qemu 可能并不支持 python3，他兼容的是 python2.7 版本，我不太想进行环境更改，因为这个虚拟机还有很多任务要用到 python3。我想到的解决方法：1、等技术成熟了尝试修改 afl 使其兼容 python3 的版本（估计够呛） 2、有时间重新配置一台虚拟机，目前碍于硬盘空间问题只能暂时搁置。</p>
</blockquote>
<h3 id="六-关于afl生态介绍"><a class="markdownIt-Anchor" href="#六-关于afl生态介绍">#</a> 六、关于 AFL 生态介绍</h3>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9iYnMucGVkaXkuY29tL3RocmVhZC0yNTEwNTEuaHRt">https://bbs.pediy.com/thread-251051.htm</span> 这篇文章详细介绍了 AFL 的生态：不同的插件用于不同的环境及条件。</p>
</blockquote>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_AwIJN42zg2.png" class="" title="AFL生态圈">
<h3 id="七-补充"><a class="markdownIt-Anchor" href="#七-补充">#</a> 七、补充：</h3>
<h4 id="1-分析一下fuzz_out输出的目录结构"><a class="markdownIt-Anchor" href="#1-分析一下fuzz_out输出的目录结构">#</a> 1、分析一下 fuzz_out 输出的目录结构：</h4>
<p>（1）由于之前尝试了并行模式所以在输出文件夹内，会单独生成不同的 M/S 的文件夹</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_WWlVHrJYog.png" class="">
<p>（2）输出文件的目录结构由 crashes、hangs、queue、bitmap、stats、plot_data 组成</p>
<img data-src="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/image_F45rY3yNg-.png" class="">
<ul>
<li>
<p>crashes：主要是 fuzzing 过程中产生异常崩溃的 crash 文件。</p>
</li>
<li>
<p>hangs：记录当异常导致程序挂起（超时）的用例。</p>
</li>
<li>
<p>queue：记录了独特（不同）执行路径的测试用例。</p>
</li>
<li>
<p>fuzz_bitmap：程序被 fuzzing 的函数映射。</p>
</li>
<li>
<p>fuzzer_stats：记录了 fuzzer 的执行状态。</p>
</li>
<li>
<p>plot_data：用于 afl-plot 绘图。</p>
</li>
</ul>
<h3 id="最后"><a class="markdownIt-Anchor" href="#最后">#</a> 最后</h3>
<blockquote>
<p>暂时搁置的内容：通过在网上找到的资料看到很多师傅对 afl 很多文件进行了更改，这需要对 afl 的源码进行细致的分析，目前不知道要深入做些什么，所以就没继续深究下去，其次，有的师傅在做实验的时候用到了 LAVA-M 数据集进行真实环境测试，目前不知道是否要研究这块内容，并且需要服务器环境，因此暂时搁置。再者，很多师傅都会研究 AFL 的头文件，我也看了很多相关的内容，内容涉及原理比较复杂，虽然可以看懂大概逻辑，及要表达的意思，但是感觉自己没能深入到点上，怕做无效的深入浪费时间，暂时搁置。</p>
</blockquote>

      <div class="tags">
          <a href="/tags/%E5%88%9D%E6%8E%A2Fuzzing/" rel="tag"><i class="ic i-tag"></i> 初探Fuzzing</a>
          <a href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/" rel="tag"><i class="ic i-tag"></i> 二进制</a>
          <a href="/tags/%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/" rel="tag"><i class="ic i-tag"></i> 模糊测试</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2022-07-22 03:35:17" itemprop="dateModified" datetime="2022-07-22T03:35:17+08:00">2022-07-22</time>
  </span>
  <span id="2022/07/02/AFL学习基础初探/" class="item leancloud_visitors" data-flag-title="AFL基础学习" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝奶茶~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.jpg" alt="Siegfried 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.jpg" alt="Siegfried 支付宝">
        <p>支付宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>Siegfried <i class="ic i-at"><em>@</em></i>中二笔记 · 癫^.^
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/" title="AFL基础学习">http://example.com/2022/07/02/AFL学习基础初探/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
    </div>
    <div class="item right">
    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#afl%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0"><span class="toc-number">1.</span> <span class="toc-text"> AFL 基础学习</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E8%A8%80afl%E9%80%82%E7%94%A8%E4%BA%8Elinux%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84cc%E7%A8%8B%E5%BA%8F%E8%BF%9B%E8%A1%8C%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84fuzzing%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="toc-number">1.0.0.1.</span> <span class="toc-text"> 前言：AFL 适用于 Linux 环境下的 C&#x2F;C++ 程序进行自动化的 Fuzzing 测试工具。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-fuzzing%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.0.1.</span> <span class="toc-text"> 一、Fuzzing 对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C-%E5%85%B3%E4%BA%8E%E4%BB%A3%E7%A0%81%E6%8F%92%E6%A1%A9"><span class="toc-number">1.0.2.</span> <span class="toc-text"> 二、关于代码插桩</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BB%A3%E7%A0%81%E6%8F%92%E6%A1%A9%E5%88%B0fuzzing%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">1.0.2.1.</span> <span class="toc-text"> 1、代码插桩到 fuzzing 的流程：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%B0%83%E7%94%A8linux%E4%B8%8B%E6%B1%87%E7%BC%96%E5%99%A8as%E6%8F%92%E5%85%A5%E6%A1%A9%E4%BB%A3%E7%A0%81"><span class="toc-number">1.0.2.2.</span> <span class="toc-text"> 2、调用 linux 下汇编器 as 插入桩代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-forksever%E8%BF%9B%E8%A1%8Cfork%E4%B8%8Efuzzer%E9%80%9A%E4%BF%A1"><span class="toc-number">1.0.2.3.</span> <span class="toc-text"> 3、 forksever 进行 fork 与 fuzzer 通信：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-afl%E4%BD%BF%E7%94%A8%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E8%BF%9B%E8%A1%8Cfuzzer%E4%B8%8Etarget%E7%A8%8B%E5%BA%8F%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BF%A1%E6%81%AF%E4%BC%A0%E9%80%92"><span class="toc-number">1.0.2.4.</span> <span class="toc-text"> 4、AFL 使用共享内存进行 fuzzer 与 target 程序之间的信息传递：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E4%B8%8D%E5%90%8C%E7%9A%84fork%E4%BF%A1%E6%81%AF%E8%BF%9B%E8%A1%8C%E8%AE%B0%E5%BD%95%E5%88%86%E6%9E%90"><span class="toc-number">1.0.2.5.</span> <span class="toc-text"> 5、不同的 fork 信息进行记录 &amp; 分析：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E6%88%91%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%AF%B9%E7%BC%96%E8%AF%91%E6%8F%92%E6%A1%A9%E7%9A%84%E6%B5%85%E6%98%BE%E7%90%86%E8%A7%A3%E4%B8%BA%E5%85%B6%E4%B8%BB%E8%A6%81%E7%9B%AE%E7%9A%84%E5%9C%A8%E4%BA%8E%E8%AE%B0%E5%BD%95%E5%B9%B6%E5%88%86%E6%9E%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%94%AF%E6%AE%B5%E7%9A%84%E6%89%A7%E8%A1%8C%E6%83%85%E5%86%B5-%E6%AC%A1%E6%95%B0-%E5%B4%A9%E6%BA%83%E6%83%85%E5%86%B5%E7%AD%89%E7%AD%89"><span class="toc-number">1.0.2.6.</span> <span class="toc-text"> 总结：我现阶段对编译插桩的浅显理解为，其主要目的在于记录并分析代码分支段的执行情况、次数、崩溃情况等等。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89-%E5%85%B3%E4%BA%8Eafl%E7%9A%84%E7%A7%8D%E5%AD%90%E5%8F%98%E5%BC%82%E7%AD%96%E7%95%A5"><span class="toc-number">1.0.3.</span> <span class="toc-text"> 三、关于 AFL 的种子变异策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E6%96%87%E4%BB%B6%E5%8F%98%E5%BC%82%E6%96%B9%E6%B3%95"><span class="toc-number">1.0.3.1.</span> <span class="toc-text"> （1）文件变异方法：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E6%96%87%E4%BB%B6%E5%8F%98%E5%BC%82%E7%AD%96%E7%95%A5"><span class="toc-number">1.0.3.2.</span> <span class="toc-text"> （2）文件变异策略：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-afl%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%8F%82%E6%95%B0%E8%A7%A3%E8%AF%BB"><span class="toc-number">1.0.4.</span> <span class="toc-text"> 四、AFL 相关工具使用及参数解读：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-afl-fuzz%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="toc-number">1.0.4.1.</span> <span class="toc-text"> 1、afl-fuzz 常用参数：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-afl%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">1.0.4.2.</span> <span class="toc-text"> 2、afl 常用工具：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1afl-cmin"><span class="toc-number">1.0.4.3.</span> <span class="toc-text"> （1）afl-cmin：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93cmin%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%E4%BB%A5%E6%88%91%E7%9A%84%E4%BE%8B%E5%AD%90%E6%9D%A5%E7%9C%8B%E5%86%8D%E7%BB%93%E5%90%88%E8%B5%84%E6%96%99%E5%8F%AF%E4%BB%A5%E7%9F%A5%E9%81%93cmin%E5%B0%B1%E6%98%AF%E4%BB%8Ecase1%E5%BC%80%E5%A7%8B%E6%B5%8B%E8%AF%95%E5%A6%82%E6%9E%9Ccase2case-the-end%E9%83%BD%E4%BC%9A%E8%BE%BE%E5%88%B0%E7%9B%B8%E5%90%8C%E7%9A%84%E6%95%88%E6%9E%9C%E9%82%A3%E4%B9%88%E5%9C%A8%E6%B5%8B%E8%AF%95%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%80%90%E4%B8%80%E8%88%8D%E5%8E%BB%E5%8F%AA%E4%BF%9D%E7%95%99case1"><span class="toc-number">1.0.4.4.</span> <span class="toc-text"> 总结：cmin 的处理方式以我的例子来看再结合资料，可以知道 cmin 就是从 case1 开始测试，如果 case2…case the end 都会达到相同的效果，那么在测试的过程中逐一舍去，只保留 case1.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2afl-tmin"><span class="toc-number">1.0.4.5.</span> <span class="toc-text"> （2）afl-tmin：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3afl-plot"><span class="toc-number">1.0.4.6.</span> <span class="toc-text"> （3）afl-plot：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4afl-whatsup"><span class="toc-number">1.0.4.7.</span> <span class="toc-text"> （4）afl-whatsup：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E5%AE%8C%E6%95%B4fuzzing%E6%B5%8B%E8%AF%95%E6%B5%81%E7%A8%8B"><span class="toc-number">1.0.5.</span> <span class="toc-text"> 五、完整 Fuzzing 测试流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AF%B9%E6%9C%89%E6%BA%90%E7%A0%81%E7%A8%8B%E5%BA%8F%E8%BF%9B%E8%A1%8C%E6%99%AE%E9%80%9Afuzzing%E6%B5%8B%E8%AF%95"><span class="toc-number">1.0.5.1.</span> <span class="toc-text"> 1、对有源码程序进行普通 fuzzing 测试：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AF%B9%E6%9C%89%E6%BA%90%E7%A0%81%E7%A8%8B%E5%BA%8F%E8%BF%9B%E8%A1%8Cdumb-mode-d%E6%B5%8B%E8%AF%95"><span class="toc-number">1.0.5.2.</span> <span class="toc-text"> 2、对有源码程序进行 dumb mode (-d) 测试：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AF%B9%E6%9C%89%E6%BA%90%E7%A0%81%E7%A8%8B%E5%BA%8F%E8%BF%9B%E8%A1%8C%E5%B9%B6%E8%A1%8C%E6%B5%8B%E8%AF%95fuzzer-m-s"><span class="toc-number">1.0.5.3.</span> <span class="toc-text"> 3、对有源码程序进行并行测试 fuzzer (-M -S)：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%AF%B9%E6%97%A0%E6%BA%90%E7%A0%81%E7%9A%84%E7%A8%8B%E5%BA%8F%E8%BF%9B%E8%A1%8Cqemu-mode%E6%B5%8B%E8%AF%95"><span class="toc-number">1.0.5.4.</span> <span class="toc-text"> 4、对无源码的程序进行 QEMU mode 测试：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD-%E5%85%B3%E4%BA%8Eafl%E7%94%9F%E6%80%81%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.0.6.</span> <span class="toc-text"> 六、关于 AFL 生态介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83-%E8%A1%A5%E5%85%85"><span class="toc-number">1.0.7.</span> <span class="toc-text"> 七、补充：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%8Bfuzz_out%E8%BE%93%E5%87%BA%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.0.7.1.</span> <span class="toc-text"> 1、分析一下 fuzz_out 输出的目录结构：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">1.0.8.</span> <span class="toc-text"> 最后</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li class="active"><a href="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/" rel="bookmark" title="AFL基础学习">AFL基础学习</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="Siegfried"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">Siegfried</p>
  <div class="description" itemprop="description">希望沉醉在二进制的乌托邦里！</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">1</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">1</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">3</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

        
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Fuzzing%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95/" title="分类于 Fuzzing模糊测试">Fuzzing模糊测试</a>
</div>

    <span><a href="/2022/07/02/AFL%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80%E5%88%9D%E6%8E%A2/" title="AFL基础学习">AFL基础学习</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Siegfried @ D0ub1e_D</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/07/02/AFL学习基础初探/',
    favicon: {
      show: "Binary woker",
      hide: "D0ub1e_D's Blog"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
